# Je viens de rediger un plan pour faire une analyse de regression multiple
# Les donnÃ©es sont sur mon ordinateur et je demanderais a ChatGPT de m'assister pour le codification

# Premiere Etape
# Je dois converir les fichier qui contient les donnes de format excel (.xls)
  vers comma separated value (.csv)
# Code Source en Python
  
import os
import pandas as pd
import glob
import shutil

# === 1. Dossiers ===
xls_folder = './DATACOT/'
output_folder = './cleaned_cot/'
backup_folder = './backup_cot_xls/'

# CrÃ©er les dossiers de sortie
os.makedirs(output_folder, exist_ok=True)
os.makedirs(backup_folder, exist_ok=True)

# === 2. Fichiers .xls ===
xls_files = glob.glob(os.path.join(xls_folder, '*.xls'))

# === 3. ParamÃ¨tres de filtrage ===
colonnes_a_garder = [
    'Market_and_Exchange_Names',
    'Report_Date_as_MM_DD_YYYY',
    'Open_Interest_All',
    'Asset_Mgr_Positions_Long_All',
    'Lev_Money_Positions_Long_All',
    'Other_Rept_Positions_Long_All'
]

devises = [
    'SO AFRICAN RAND',
    'SWISS FRANC',
    'CANADIAN DOLLAR'
]

# === 4. Traitement sÃ©curisÃ© ===
for file_path in xls_files:
    try:
        # Faire une copie de sauvegarde
        shutil.copy(file_path, backup_folder)

        # Charger le fichier
        df = pd.read_excel(file_path, engine='xlrd')

        # VÃ©rifier si la colonne existe avant de filtrer
        if 'Market_and_Exchange_Names' not in df.columns:
            print(f"âš ï¸ Colonne manquante dans {file_path}. Fichier ignorÃ©.")
            continue

        # Filtrer par devise
        df_filtered = df[df['Market_and_Exchange_Names'].str.upper().apply(
            lambda x: any(devise in x for devise in [d.upper() for d in devises])
        )]


        # VÃ©rifier si des donnÃ©es ont Ã©tÃ© trouvÃ©es
        if df_filtered.empty:
            print(f"âš ï¸ Aucun rÃ©sultat pour les devises dans {file_path}. Fichier ignorÃ©.")
            continue

        # SÃ©lectionner les colonnes disponibles
        colonnes_existantes = [col for col in colonnes_a_garder if col in df_filtered.columns]
        df_final = df_filtered[colonnes_existantes]

        # Sauvegarder uniquement si le DataFrame contient des donnÃ©es
        if not df_final.empty:
            base_name = os.path.basename(file_path).replace('.xls', '.csv')
            output_path = os.path.join(output_folder, base_name)
            df_final.to_csv(output_path, index=False)
            print(f"âœ… Fichier nettoyÃ© et sauvegardÃ© : {output_path}")
        else:
            print(f"âš ï¸ {file_path} contient des colonnes mais aucune donnÃ©e Ã  sauvegarder.")

    except Exception as e:
        print(f"âŒ Erreur avec le fichier {file_path} : {e}")

# === 5. Suppression des .xls UNIQUEMENT si les fichiers nettoyÃ©s existent ===
for file_path in xls_files:
    base_name = os.path.basename(file_path).replace('.xls', '.csv')
    cleaned_path = os.path.join(output_folder, base_name)
    
    if os.path.exists(cleaned_path) and os.path.getsize(cleaned_path) > 0:
        try:
            os.remove(file_path)
            print(f"ğŸ—‘ï¸ Ancien fichier supprimÃ© : {file_path}")
        except Exception as e:
            print(f"âŒ Impossible de supprimer {file_path} : {e}")
    else:
        print(f"ğŸš« Fichier conservÃ© (pas de version nettoyÃ©e) : {file_path}")

# Resultats
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2020.csv
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2021.csv
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2022.csv
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2023.csv
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2024.csv
âœ… Fichier nettoyÃ© et sauvegardÃ© : ./cleaned_cot/FinFutYY 2025.csv
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2020.xls
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2021.xls
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2022.xls
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2023.xls
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2024.xls
ğŸ—‘ï¸ Ancien fichier supprimÃ© : ./DATACOT\FinFutYY 2025.xls
